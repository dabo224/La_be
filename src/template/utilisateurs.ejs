<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        body{
            font-size: 14px;
        }
        section{
            margin-top: 60px;

        }
        section h1{
            margin: auto;
        }
        .friend-section{
            display: grid;
            grid-template-columns:1fr 40% 1fr;
        }

        .friend-user *{
            margin: 0;
            padding: 0;
        }
        .friend-user {
            display: grid;
            grid-template-rows:150px 55px ;
            /* width: 205px; */
            /* border: solid 0.3px; */
            border-radius: 10px;
            box-shadow: 15px 15px 10px  rgba(0, 0, 0, 0.3);

        }
        .friend-user img{
            grid-row-start: 1;
            grid-row-end: -1;
            grid-column: 1 / 2;
            width: 100%;
            height: 100%;
            border-radius: 10px;

        }
        .friend-user .bouton{
            grid-row: 3 / 2;
            grid-column: 1 / 2;
            display: flex;
            align-items: center;
            flex-direction: column;
            background-color: #f0f2f5;
            border-radius:0  0 10px 10px;
        }
        .friend-user .bouton button{
            border-radius: 5px;
            border: none;
            padding: 3px;
            margin: 2px;
        }
        .friend-user .bouton .action{
            width: 100%;
            display: grid;
            grid-template-columns: repeat(2,1fr);
            justify-content: space-between;
            padding: 3px;

        }
        .friend-user .bouton p{
            background-color: white;
            padding: 3px;
            width: 97%;
        }
        .friend-user .bouton .action :first-child{
            background-color: blue;
        }
        .friend-user .bouton .action :last-child{
            background-color: red;
        }
        #friend{
            display: grid;
            grid-template-columns: repeat(2,1fr);
            grid-gap: 20px;
        }
        section h1{
            margin: 20px 0;
            text-align: center;
        }
        .status{
            background-color: green;
            border-radius: 5px;
            width: 100%;
            text-align: center;
            height: fit-content;

        }
    </style>
</head>
<body>
    <%- include('./partials/header') %>

    <div class="friend-section">
        <div></div>
        <section>
                <h1>Amis</h1>
                <div id="friend">
                    <% if (amis) {%>
                    <% amis.forEach(user => {%>
                        
                        <!-- <div class="friend"> -->
                
                            <div class="friend-user">
                                <img src="/static/profil/<%= user.Profil.urlPhoto %>" alt="">

                                <div class="bouton">
                                    <p><%= user.prenom %> <%= user.nom %></p>
                                    
                                    <div class="action">
                                        <% if (user.Reception) {%>
                                            <button class="acc_demande" data-friendId="<%= user.id %>">Valider Demande</button>
                                            <button class="ref_demande">Refuser</button>
                                        <% }else if(user.Envoi) {%>
                                            <button class="ann_demande" data-friendId="<%= user.id %>">Annuler demande</button>
                                            <button class="supp">Supprimer</button>
                                        <% }else if(user.Friends) {%>
                                            <button class="voir_profil" data-friendId="<%= user.id %>">Voir Profil</button>
                                            <button class="supp">Supprimer</button>
                                        <% }else {%>
                                            <button class="ajout_ami" data-friendId="<%= user.id %>">Ajouter Ami(e)</button>
                                            <button class="voir_profil">Voir Profil</button>
                                        <% } %>
                        
                                    </div>
                                    <!-- <div class=" status">
                                        Vous êtes amis
                                    </div> -->
                                </div>
                            </div>
                        <!-- </div> -->
                    <% 
                    }); 
                     %>
                     <% } %>
                </div>
                <h1>Demande En Attente</h1>
                <div id="friend">
                    <% if (attentes) {%>
                    <% attentes.forEach(user => {%>
                        
                        <!-- <div class="friend"> -->
                
                            <div class="friend-user">
                                <img src="/static/profil/<%= user.Profil.urlPhoto %>" alt="">

                                <div class="bouton">
                                    <p><%= user.prenom %> <%= user.nom %></p>
                                    
                                    <div class="action">
                                        
                                        <% if (user.Reception) {%>
                                            <button class="acc_demande" data-friendId="<%= user.id %>" data-notifId="<%= user.Reception %>">Accepter</button>
                                            <button class="ref_demande" data-notifId="<%= user.Reception %>">Refuser</button>
                                        <% }else if(user.Envoi) {%>
                                            <button class="supp">Voir Profil</button>
                                            <button class="ann_demande" data-notifId="<%= user.Envoi %>" data-friendId="<%= user.id %>">Annuler</button>
                                        <% }else if(user.Friends) {%>
                                            <button class="voir_profil" data-friendId="<%= user.id %>">Voir Profil</button>
                                            <button class="supp">Supprimer</button>
                                        <% }else {%>
                                            <button class="ajout_ami" data-friendId="<%= user.id %>">Ajouter Ami(e)</button>
                                            <button class="voir_profil">Voir Profil</button>
                                        <% } %>
                        
                                    </div>
                                    <!-- <div class=" status">
                                        Vous êtes amis
                                    </div> -->
                                </div>
                            </div>
                        <!-- </div> -->
                    <% 
                    }); 
                     %>
                     <% } %>
                </div>
                <h1>Suggestions</h1>
                <div id="friend">
                    <% if (suggestions) {%>
                    <% suggestions.forEach(user => {%>
                        
                        <!-- <div class="friend"> -->
                
                            <div class="friend-user">
                                <img src="/static/profil/<%= user.Profil.urlPhoto %>" alt="">

                                <div class="bouton">
                                    <p><%= user.prenom %> <%= user.nom %></p>
                                    
                                    <div class="action">
                                        <% if (user.Reception) {%>
                                            <button class="acc_demande" data-friendId="<%= user.id %>" data-notifId="<%= user.Reception.id %>" >Valider Demande</button>
                                            <button class="ref_demande"data-notifId="<%= user.Reception.id %>">Refuser</button>
                                        <% }else if(user.Envoi) {%>
                                            <button class="ann_demande" data-friendId="<%= user.id %>">Annuler demande</button>
                                            <button class="supp">Supprimer</button>
                                        <% }else if(user.Friends) {%>
                                            <button class="voir_profil" data-friendId="<%= user.id %>">Voir Profil</button>
                                            <button class="supp">Supprimer</button>
                                        <% }else {%>
                                            <button class="ajout_ami" data-friendId="<%= user.id %>">Ajouter Ami(e)</button>
                                            <button class="voir_profil">Voir Profil</button>
                                        <% } %>
                        
                                    </div>
                                    <!-- <div class=" status">
                                        Vous êtes amis
                                    </div> -->
                                </div>
                            </div>
                        <!-- </div> -->
                    <% 
                    }); 
                     %>
                     <% } %>
                </div>
            </section>
            <div></div>
        </div>
        
        <script>
            // Gestion du bouton Accepter demande pour l'ajout d'un ami
            document.querySelectorAll('.ajout_ami').forEach(acc =>{
                acc.addEventListener('click',async()=>{
            const response = await fetch('/notif?demande=true',{
                method : 'Post',
                headers: {
                    'Content-Type': 'application/json'
                },
    
                body:JSON.stringify({userID : acc.getAttribute('data-friendId'),senderId:decode().userId})
            })

                if (response.ok){
                    alert('Demande envoye avec succès') 
                }
                })
            })
            // Gestion du bouton Refuser pour refuser une demande 

            document.querySelectorAll('.ref_demande').forEach(element =>{
                element.addEventListener('click',async ()=>{
                    alert(element.textContent)
                    const response = await fetch(`/notif/${element.getAttribute('data-notifId')}`,{
                        method : 'DELETE'
                    })
                    const result =await response.json()
                    console.log(result)
                    if(result.delete){

                        const parent = element.parentElement
                        const parent1 = parent.parentElement
                        parent1.parentElement.style.display = 'none'
                    }
                })
            })
            // Gestion du bouton valider demande pour l'acceptation d'une demande d'ami
            document.querySelectorAll('.acc_demande').forEach(  element =>{
                element.addEventListener('click',async() =>{

                    const response = await fetch('/friend',{
                        method : 'POST',
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body : JSON.stringify({friendId : element.getAttribute('data-friendId'),userId : decode().userId})
                    })
                    const result = await response.json()
                    if(result.friend){
    
                        const parent = element.parentElement
                        const parent1 = parent.parentElement
                        parent1.parentElement.style.display = 'none'
                        alert('Demande d\'amis accepté avec succès')
                        const response = await fetch(`/notif/${element.getAttribute('data-notifId')}?all=true`,{
                        method : 'DELETE'
                    })
                    }
                })
            })

            // Gestion du bouton annuler pour annuler une demande d'ami

            document.querySelectorAll('.ann_demande').forEach(element =>{
            element.addEventListener('click',async()=>{
                const response = await fetch(`/notif/${element.getAttribute('data-notifId')}?all=true`,{
                    method : 'DELETE'
                })
                const result =await response.json()
                console.log(result)
                if(result.delete){
                    location.reload()
                    const parent = element.parentElement
                    const parent1 = parent.parentElement
                    parent1.parentElement.style.display = 'none'
                }
            })
            })
        </script>
</body>
</html>